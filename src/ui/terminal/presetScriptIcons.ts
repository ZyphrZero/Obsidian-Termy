/**
 * 预设脚本图标工具
 */

import { setIcon } from 'obsidian';
import type { SimpleIcon } from 'simple-icons';
import {
  siAnthropic,
  siCloudflare,
  siClaude,
  siDocker,
  siFirebase,
  siGit,
  siGithub,
  siGitlab,
  siGo,
  siGoogle,
  siJavascript,
  siKubernetes,
  siLinux,
  siMongodb,
  siMysql,
  siNodedotjs,
  siNpm,
  siOpenai,
  siPnpm,
  siPostgresql,
  siPython,
  siReact,
  siRedis,
  siRust,
  siSupabase,
  siTailwindcss,
  siTypescript,
  siUbuntu,
  siVercel,
  siVuedotjs,
  siYarn,
  siNextdotjs,
} from 'simple-icons';

const SIMPLE_ICON_MAP: Record<string, SimpleIcon> = {
  openai: siOpenai,
  openaiapi: siOpenai,
  claude: siClaude,
  anthropic: siAnthropic,
  google: siGoogle,
  python: siPython,
  javascript: siJavascript,
  typescript: siTypescript,
  nodejs: siNodedotjs,
  go: siGo,
  rust: siRust,
  react: siReact,
  vue: siVuedotjs,
  nextjs: siNextdotjs,
  tailwindcss: siTailwindcss,
  github: siGithub,
  gitlab: siGitlab,
  git: siGit,
  docker: siDocker,
  kubernetes: siKubernetes,
  postgresql: siPostgresql,
  mysql: siMysql,
  redis: siRedis,
  mongodb: siMongodb,
  supabase: siSupabase,
  firebase: siFirebase,
  vercel: siVercel,
  cloudflare: siCloudflare,
  linux: siLinux,
  ubuntu: siUbuntu,
  npm: siNpm,
  pnpm: siPnpm,
  yarn: siYarn,
};

const SIMPLE_ICON_ORDER = [
  'openai',
  'claude',
  'anthropic',
  'google',
  'python',
  'javascript',
  'typescript',
  'nodejs',
  'go',
  'rust',
  'react',
  'vue',
  'nextjs',
  'tailwindcss',
  'github',
  'gitlab',
  'git',
  'docker',
  'kubernetes',
  'postgresql',
  'mysql',
  'redis',
  'mongodb',
  'supabase',
  'firebase',
  'vercel',
  'cloudflare',
  'linux',
  'ubuntu',
  'npm',
  'pnpm',
  'yarn',
] as const;

const DEFAULT_ICON_OPTIONS = [
  // 基础与终端
  'terminal',
  'terminal-square',
  'command',
  'code',
  'file-code',
  'folder',
  'folder-open',
  'files',
  'search',
  'filter',
  // 执行动作
  'play',
  'pause',
  'square',
  'refresh-cw',
  'rotate-ccw',
  'download',
  'upload',
  // 开发与部署
  'git-branch',
  'git-commit',
  'git-merge',
  'git-pull-request',
  'database',
  'server',
  'hard-drive',
  'package',
  'box',
  // 操作与编辑
  'copy',
  'clipboard',
  'scissors',
  'trash',
  'plus',
  'minus',
  // 配置与工具
  'settings',
  'sliders-horizontal',
  'wrench',
  'hammer',
  // 状态与提醒
  'check',
  'x',
  'alert-triangle',
  'info',
  'bell',
  'clock',
  'calendar',
  // 安全与网络
  'shield',
  'lock',
  'unlock',
  'key',
  'globe',
  'link',
  // 常用语义
  'sparkles',
  'wand-2',
  'bot',
  'cpu',
  'rocket',
  'zap',
  'activity',
  'bug',
  'test-tube',
  'flask-conical',
  'book-open',
  'lightbulb',
  'list',
];

export const PRESET_SCRIPT_ICON_OPTIONS = [
  'terminal',
  ...SIMPLE_ICON_ORDER,
  ...DEFAULT_ICON_OPTIONS.filter((iconName) => iconName !== 'terminal'),
];

const emojiRegex = /\p{Extended_Pictographic}/u;

function isEmojiIcon(iconName: string): boolean {
  return emojiRegex.test(iconName);
}

export function isCustomPresetScriptIcon(iconName: string): boolean {
  const lookup = iconName.toLowerCase();
  return lookup in SIMPLE_ICON_MAP;
}

export function renderPresetScriptIcon(el: HTMLElement, iconName: string): void {
  const rawInput = (iconName ?? '').trim();
  const raw = rawInput || 'terminal';
  const lookup = raw.toLowerCase();
  el.empty();

  el.removeClass('preset-script-custom-icon');
  el.removeClass('preset-script-emoji-icon');
  el.removeAttribute('data-icon');
  el.style.removeProperty('--preset-script-icon-color');

  if (rawInput && isEmojiIcon(rawInput)) {
    el.addClass('preset-script-emoji-icon');
    el.textContent = rawInput;
    return;
  }

  if (isCustomPresetScriptIcon(raw)) {
    const icon = SIMPLE_ICON_MAP[lookup];
    el.addClass('preset-script-custom-icon');
    el.setAttr('data-icon', lookup);
    if (icon.hex) {
      el.style.setProperty('--preset-script-icon-color', `#${icon.hex}`);
    }

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('viewBox', '0 0 24 24');
    svg.setAttribute('aria-hidden', 'true');

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('fill', 'currentColor');
    path.setAttribute('d', icon.path);
    svg.appendChild(path);

    el.appendChild(svg);
    return;
  }

  setIcon(el, raw);
}

export function resolveMenuIconName(iconName: string): string {
  const raw = (iconName || 'terminal').trim();
  if (isCustomPresetScriptIcon(raw)) {
    return 'terminal';
  }
  return raw;
}
